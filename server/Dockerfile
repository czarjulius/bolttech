FROM node:20.5.0

## Add the wait script to the image
ADD https://github.com/ufoscout/docker-compose-wait/releases/download/2.9.0/wait /wait
RUN chmod +x /wait

RUN apt-get update

ARG DB_USERNAME
ARG DB_PASSWORD
ARG DB_NAME
ARG DB_HOST
ARG DB_PORT
ARG APP_CONTEXT
ARG GOOGLE_CLIENT_ID
ARG GOOGLE_CLIENT_SECRET
ARG JWT_SECRET
ARG JWT_EXPIRES_IN
ARG FACEBOOK_CLIENT_ID
ARG FACEBOOK_CLIENT_SECRET
ARG FACEBOOK_REDIRECT_URI
ARG PAYSTACK_SECRET_KEY
ARG REGISTER_LINK
ARG SEND_GRID_KEY
ARG ACTIVE_MAIL_SERVICE
ARG REFERRAL_BONUS_AMOUNT
ARG CLOUDINARY_NAME
ARG CLOUDINARY_API_KEY
ARG CLOUDINARY_SECRET
ARG ORLA_WEB_LINK
ARG SEND_GRID_FROM
ARG REDIS_URL

ENV REDIS_URL=${REDIS_URL}
ENV SEND_GRID_FROM=${SEND_GRID_FROM}
ENV ORLA_WEB_LINK=${ORLA_WEB_LINK}
ENV CLOUDINARY_SECRET=${CLOUDINARY_SECRET}
ENV CLOUDINARY_API_KEY=${CLOUDINARY_API_KEY}
ENV CLOUDINARY_NAME=${CLOUDINARY_NAME}
ENV DB_USERNAME=${DB_USERNAME}
ENV DB_PASSWORD=${DB_PASSWORD}
ENV DB_NAME=${DB_NAME}
ENV DB_HOST=${DB_HOST}
ENV DB_PORT=${DB_PORT}
ENV APP_CONTEXT=${APP_CONTEXT}
ENV GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
ENV GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
ENV JWT_SECRET=${JWT_SECRET}
ENV JWT_EXPIRES_IN=${JWT_EXPIRES_IN}
ENV FACEBOOK_CLIENT_ID=${FACEBOOK_CLIENT_ID}
ENV FACEBOOK_CLIENT_SECRET=${FACEBOOK_CLIENT_SECRET}
ENV FACEBOOK_REDIRECT_URI=${FACEBOOK_REDIRECT_URI}
ENV PAYSTACK_SECRET_KEY=${PAYSTACK_SECRET_KEY}
ENV REGISTER_LINK=${REGISTER_LINK}
ENV ACTIVE_MAIL_SERVICE=${ACTIVE_MAIL_SERVICE}
ENV SEND_GRID_KEY=${SEND_GRID_KEY}
ENV REFERRAL_BONUS_AMOUNT=${REFERRAL_BONUS_AMOUNT}

WORKDIR /usr/app

COPY package.json .
RUN npm install
COPY . .
RUN npm run build

RUN npm run migration

ENTRYPOINT [ "npm", "run", "start" ]